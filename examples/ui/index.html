<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClaudeMCP — Ableton Live Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #111214;
      --surface:  #1c1e22;
      --border:   #2e3138;
      --text:     #d4d8e0;
      --muted:    #6b7280;
      --accent:   #5b6af0;
      --green:    #22c55e;
      --red:      #ef4444;
      --amber:    #f59e0b;
      --radius:   6px;
      --font:     "Inter", "Segoe UI", system-ui, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* ── Top bar ─────────────────────────────────────────── */
    #topbar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 10px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    #topbar h1 {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: .04em;
      color: var(--text);
      white-space: nowrap;
    }

    #conn-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 99px;
      font-size: 12px;
      font-weight: 500;
      background: #1f2226;
      border: 1px solid var(--border);
      transition: border-color .2s;
    }
    #conn-pill .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--red);
      transition: background .2s;
    }
    #conn-pill.connected   .dot { background: var(--green); }
    #conn-pill.connected        { border-color: var(--green); }
    #conn-pill.connecting  .dot { background: var(--amber); }
    #conn-pill.connecting       { border-color: var(--amber); }

    /* ── Transport ───────────────────────────────────────── */
    #transport {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: #23262d;
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background .15s, border-color .15s;
      white-space: nowrap;
    }
    .btn:hover   { background: #2d3038; border-color: #444; }
    .btn:active  { background: #1a1c22; }
    .btn.active  { background: #1e2540; border-color: var(--accent); color: #8fa8ff; }
    .btn.danger  { border-color: #5a2626; }
    .btn.danger:hover { background: #3a1a1a; border-color: var(--red); }
    .btn.record.active { background: #2d1515; border-color: var(--red); color: var(--red); }

    .divider { width: 1px; height: 24px; background: var(--border); margin: 0 4px; }

    #tempo-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #tempo-group label { color: var(--muted); font-size: 12px; }
    #tempo-display {
      font-size: 18px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      min-width: 56px;
      text-align: center;
    }
    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: #23262d;
      color: var(--text);
      cursor: pointer;
    }
    .btn-sm:hover { background: #2d3038; }

    /* ── Main area ───────────────────────────────────────── */
    #main {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      gap: 0;
    }

    /* ── Session info ────────────────────────────────────── */
    #session-info {
      padding: 10px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 24px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }
    #session-info .group {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }
    #session-info .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
    }
    #session-info .value {
      font-size: 14px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    #refresh-btn {
      margin-left: auto;
    }

    /* ── Console ─────────────────────────────────────────── */
    #console-section {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      padding: 12px 16px;
      gap: 10px;
    }

    #console-section h2 {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--muted);
      flex-shrink: 0;
    }

    #log {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      background: #0d0e10;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      font-family: "JetBrains Mono", "Fira Code", "Cascadia Code", monospace;
      font-size: 12px;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .log-entry {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .log-entry .ts {
      color: var(--muted);
      flex-shrink: 0;
      font-size: 11px;
      padding-top: 1px;
    }
    .log-entry .direction {
      flex-shrink: 0;
      font-size: 11px;
      padding-top: 1px;
    }
    .log-entry .direction.out { color: var(--accent); }
    .log-entry .direction.in  { color: var(--muted); }
    .log-entry .body { word-break: break-all; }
    .log-entry.ok   .body { color: var(--green); }
    .log-entry.err  .body { color: var(--red); }
    .log-entry.sent .body { color: #7b8fa8; }
    .log-empty { color: var(--muted); font-style: italic; padding: 4px 0; }

    #input-row {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    #cmd-input {
      flex: 1;
      background: #0d0e10;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 12px;
      color: var(--text);
      font-family: "JetBrains Mono", "Fira Code", monospace;
      font-size: 13px;
      outline: none;
      transition: border-color .15s;
    }
    #cmd-input:focus { border-color: var(--accent); }
    #cmd-input::placeholder { color: var(--muted); }

    #send-btn {
      padding: 8px 18px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
    }
    #send-btn:hover   { background: #6b7af5; }
    #send-btn:disabled { background: #2d3038; color: var(--muted); cursor: default; }

    #clear-btn {
      padding: 8px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--muted);
      font-size: 13px;
      cursor: pointer;
    }
    #clear-btn:hover { background: #1f2226; color: var(--text); }

    /* scrollbar */
    #log::-webkit-scrollbar { width: 6px; }
    #log::-webkit-scrollbar-track { background: transparent; }
    #log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

<!-- Top bar -->
<div id="topbar">
  <h1>ClaudeMCP Dashboard</h1>
  <div id="conn-pill">
    <span class="dot"></span>
    <span id="conn-label">Disconnected</span>
  </div>
</div>

<!-- Transport -->
<div id="transport">
  <button class="btn" id="btn-play"   onclick="transport('start_playback')">&#9654; Play</button>
  <button class="btn" id="btn-stop"   onclick="transport('stop_playback')">&#9632; Stop</button>
  <button class="btn record" id="btn-rec" onclick="transport('start_recording')">&#9679; Record</button>

  <div class="divider"></div>

  <div id="tempo-group">
    <label>BPM</label>
    <span id="tempo-display">—</span>
    <button class="btn-sm" onclick="adjustTempo(-1)">−</button>
    <button class="btn-sm" onclick="adjustTempo(+1)">+</button>
  </div>
</div>

<!-- Session info -->
<div id="session-info">
  <div class="group">
    <span class="label">Time Sig</span>
    <span class="value" id="si-timesig">—</span>
  </div>
  <div class="group">
    <span class="label">Tracks</span>
    <span class="value" id="si-tracks">—</span>
  </div>
  <div class="group">
    <span class="label">Scenes</span>
    <span class="value" id="si-scenes">—</span>
  </div>
  <div class="group">
    <span class="label">Playing</span>
    <span class="value" id="si-playing">—</span>
  </div>
  <button class="btn btn-sm" id="refresh-btn" onclick="refreshSessionInfo()">&#8635; Refresh</button>
</div>

<!-- Console -->
<div id="main">
  <div id="console-section">
    <h2>Command Console</h2>
    <div id="log"><span class="log-empty">No messages yet — connect to Ableton and send a command.</span></div>
    <div id="input-row">
      <input
        id="cmd-input"
        type="text"
        placeholder='{"action": "ping"}'
        spellcheck="false"
        autocomplete="off"
        onkeydown="handleInputKey(event)"
      />
      <button id="send-btn" onclick="sendFromInput()" disabled>Send</button>
      <button id="clear-btn" onclick="clearLog()">Clear</button>
    </div>
  </div>
</div>

<script>
  // ── State ──────────────────────────────────────────────────────
  let ws = null;
  let currentBpm = null;
  let cmdHistory = [];      // newest last
  let historyIdx = -1;      // -1 = live input, 0+ = browsing history
  let liveDraft = "";       // saves current draft when browsing history

  const MAX_HISTORY = 50;
  const MAX_LOG = 200;

  // ── WebSocket connection ───────────────────────────────────────
  function connect() {
    const pill = document.getElementById("conn-pill");
    const label = document.getElementById("conn-label");

    pill.className = "connecting";
    label.textContent = "Connecting…";

    ws = new WebSocket(`ws://${location.host}/ws`);

    ws.onopen = () => {
      pill.className = "connected";
      label.textContent = "Connected";
      document.getElementById("send-btn").disabled = false;
      refreshSessionInfo();
    };

    ws.onclose = () => {
      pill.className = "";
      label.textContent = "Disconnected";
      document.getElementById("send-btn").disabled = true;
      ws = null;
      // Reconnect after 3 s
      setTimeout(connect, 3000);
    };

    ws.onerror = () => {
      pill.className = "";
      label.textContent = "Error";
    };

    ws.onmessage = (evt) => {
      const data = JSON.parse(evt.data);
      appendLog("in", data);
      handleResponse(data);
    };
  }

  // ── Send helpers ───────────────────────────────────────────────
  function send(command) {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    const raw = JSON.stringify(command);
    appendLog("out", command);
    ws.send(raw);
  }

  function sendFromInput() {
    const input = document.getElementById("cmd-input");
    const raw = input.value.trim();
    if (!raw) return;

    let command;
    try {
      command = JSON.parse(raw);
    } catch (e) {
      // Allow shorthand: bare action name like  ping  → {"action":"ping"}
      if (/^[a-z_]+$/.test(raw)) {
        command = { action: raw };
      } else {
        appendLog("err", { ok: false, error: "Invalid JSON: " + e.message });
        return;
      }
    }

    send(command);

    // History
    if (cmdHistory[cmdHistory.length - 1] !== raw) {
      cmdHistory.push(raw);
      if (cmdHistory.length > MAX_HISTORY) cmdHistory.shift();
    }
    historyIdx = -1;
    liveDraft = "";
    input.value = "";
  }

  // ── History navigation ─────────────────────────────────────────
  function handleInputKey(e) {
    const input = document.getElementById("cmd-input");

    if (e.key === "Enter") {
      sendFromInput();
      return;
    }

    if (e.key === "ArrowUp") {
      e.preventDefault();
      if (cmdHistory.length === 0) return;
      if (historyIdx === -1) {
        liveDraft = input.value;
        historyIdx = cmdHistory.length - 1;
      } else if (historyIdx > 0) {
        historyIdx--;
      }
      input.value = cmdHistory[historyIdx];
      return;
    }

    if (e.key === "ArrowDown") {
      e.preventDefault();
      if (historyIdx === -1) return;
      historyIdx++;
      if (historyIdx >= cmdHistory.length) {
        historyIdx = -1;
        input.value = liveDraft;
      } else {
        input.value = cmdHistory[historyIdx];
      }
    }
  }

  // ── Transport helpers ──────────────────────────────────────────
  function transport(action) {
    send({ action });
  }

  function adjustTempo(delta) {
    if (currentBpm === null) return;
    const newBpm = Math.min(999, Math.max(20, currentBpm + delta));
    send({ action: "set_tempo", bpm: newBpm });
  }

  // ── Response handler — updates UI from responses ───────────────
  function handleResponse(data) {
    // Refresh tempo from any response that includes it
    if (data.tempo !== undefined) {
      currentBpm = data.tempo;
      document.getElementById("tempo-display").textContent = data.tempo.toFixed(1);
    }
    if (data.bpm !== undefined) {
      currentBpm = data.bpm;
      document.getElementById("tempo-display").textContent = data.bpm.toFixed(1);
    }

    // Session info
    if (data.time_signature_numerator !== undefined) {
      document.getElementById("si-timesig").textContent =
        data.time_signature_numerator + "/" + data.time_signature_denominator;
    }
    if (data.num_tracks !== undefined) {
      document.getElementById("si-tracks").textContent = data.num_tracks;
    }
    if (data.num_scenes !== undefined) {
      document.getElementById("si-scenes").textContent = data.num_scenes;
    }
    if (data.is_playing !== undefined) {
      document.getElementById("si-playing").textContent = data.is_playing ? "Yes" : "No";
    }
  }

  function refreshSessionInfo() {
    send({ action: "get_session_info" });
  }

  // ── Log rendering ──────────────────────────────────────────────
  function appendLog(direction, data) {
    const log = document.getElementById("log");

    // Remove placeholder
    const empty = log.querySelector(".log-empty");
    if (empty) empty.remove();

    const isOut = direction === "out";
    const isOk  = data.ok !== false;
    const isErr = !isOk && direction === "in";

    const entry = document.createElement("div");
    entry.className = "log-entry " + (isOut ? "sent" : (isErr ? "err" : "ok"));

    const ts = new Date().toLocaleTimeString("en-US", { hour12: false });

    entry.innerHTML =
      `<span class="ts">${ts}</span>` +
      `<span class="direction ${isOut ? "out" : "in"}">${isOut ? "→" : "←"}</span>` +
      `<span class="body">${escapeHtml(JSON.stringify(data))}</span>`;

    log.appendChild(entry);

    // Cap log length
    while (log.children.length > MAX_LOG) {
      log.removeChild(log.firstChild);
    }

    log.scrollTop = log.scrollHeight;
  }

  function clearLog() {
    const log = document.getElementById("log");
    log.innerHTML = '<span class="log-empty">Log cleared.</span>';
  }

  function escapeHtml(str) {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  // ── Boot ───────────────────────────────────────────────────────
  connect();
</script>
</body>
</html>
